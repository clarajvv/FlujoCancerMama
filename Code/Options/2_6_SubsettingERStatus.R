##borrar
setwd("D:/uma/cuarto/Herramientas y Algoritmos/functional_analysis/flujo cancer")

#cargar lirberias
source("Code/Settings/0_loadLibraries.R") # no se si hace falta con el bash, creo que no
loadpkg("dplyr")

# Cargar datos
load("Data/brca_rnaseq_tumour.RData")
load("Data/sample_data.RData")

print("Lo primero que haremos será comprobar si el que el cáncer tenga receptores de estrógenos afecta a la tasa de supervivencia")
d1 <- sample_data[sample_data$`ER Status`== "Positive",]
d2 <- sample_data[sample_data$`ER Status`!= "Positive",]
d2$`ER Status` = "Negative"
datos_limpios <- rbind(d1, d2)
tablaSupervivencia <- xtabs(~datos_limpios$`Vital Status`+ datos_limpios$`ER Status`)
pValor <- unlist(unname(fisher.test(tablaSupervivencia)[1]))

if(pValor<0.05){
  print(paste("El pvalor es ", round(pValor, 5), ", por lo que se ha encontrado relación entre ambas variables. Procederemos a efectuar un DEA."))
  
  subsettingER <- function(numNodos){
    samples <- sample_data %>% dplyr::filter(`ER Status` == numNodos)
    barcodes <- samples$`Complete TCGA ID`
    data <- brca_rnaseq.tumour[, which(colnames(brca_rnaseq.tumour) %in% barcodes)]
    return(data)
  }
  
  brca_rnaseq.ERpos <- subsettingER("Positive")
  brca_rnaseq.ERneg <- subsettingER("Negative")
  
  rnaseq.for.de <- cbind(brca_rnaseq.ERpos, brca_rnaseq.ERneg)
  counts <- rnaseq.for.de[apply(rnaseq.for.de,1,function(x) sum(x==0))<ncol(rnaseq.for.de)*0.8,]
  
  df.c1 <- data.frame("sample" = colnames(brca_rnaseq.ERpos), "status" = rep(0, length(colnames(brca_rnaseq.ERpos))) )
  df.c2 <- data.frame("sample" = colnames(brca_rnaseq.ERneg), "status" = rep(1, length(colnames(brca_rnaseq.ERneg))) )
  df <- rbind(df.c1, df.c2)
  
  design <- model.matrix(~ status, data = df)
  label <- "DEA_breast_cancer_ER_status"
  
  preDEA <- list("counts" = counts, "design" = design, "label" = label)
  save(preDEA, file = "Data/datosParaDEA.RData")
} else {
  print(paste("El pvalor es ", round(pValor, 4), ", por lo que no se ha encontrado relación entre ambas variables. El programa se detendrá."))
  quit()
}
